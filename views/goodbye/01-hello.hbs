<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Goodbye</title>

    <meta content="Goodbye_Home" property="og:title">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <meta content="Webflow" name="generator">
    <link href="/css/normalize.css" rel="stylesheet" type="text/css">
    <link href="/css/webflow.css" rel="stylesheet" type="text/css">
    <link href="/css/stephies-blank-site-a706d0.webflow.css" rel="stylesheet" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
    <script type="text/javascript">WebFont.load({  google: {    families: ["Roboto:regular","Poppins:regular","Poppins:regular,500,600,700,800,900","Roboto:regular,500,700,900","Poppins:100,200,300,regular,500,600,700,800,900","Roboto:100,300,regular,500,700,900"]  }});</script>
    <!-- [if lt IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" type="text/javascript"></script><![endif] -->
    <script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script>


    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css"/>
    <script src="/javascripts/utils.js"></script>
</head>
<body onunload="" class="body">

<div class="div-block-2"></div>
<h1 class="heading">Hello again</h1>
<p class="paragraph">Select whatever username you selected previously<br><br></p>
<div id="user-list">
    <div class="text-block-4">Name1</div>
</div>
<div class="columns w-row">
    <div class="column w-col w-col-6"><a id="not-found" class="button-5 w-button">I can&#x27;t find myself</a></div>
    <div class="w-col w-col-6"><a id="submit" class="hide button-3 w-button">Continue</a></div>
</div>

<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function(event){

    const userNameTimeout = 2 * 60  * 60 * 1000; // 2hours
    let selectedUser = null;
    let $selection = null;

    function UpdateList() {
        fetch('/data', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        }).then((response) => response.json())
                .then((data) => {
                    console.log('Success:', data);
                    RenderList(data);
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
    }

    function RenderList(data) {
        const $list = document.getElementById('user-list');
        const now = new Date();
        $list.innerHTML = '';
        for (let user of data) {
            if (user.IS_COMPLETED === 0 && now - (new Date(user.START_TIME)) < userNameTimeout ) {
                // create list item
                const $item = document.createElement('div');
                $item.classList.add("text-block-4");
                $item.setAttribute('data', user.ID);
                $item.innerText = user.DISPLAY_ID;

                // select item on click
                $item.addEventListener("click", function(e) {
                    SelectItem($item, user);
                    e.stopPropagation();
                });

                // create the item in the selected state if its id is already selected
                if (selectedUser !== null && selectedUser.ID === user.ID) {
                    SelectItem($item, user);
                }

                // add item to dom
                $list.insertBefore($item, $list.firstChild);
            }
        }
    }

    // Causes an item in the list to enter the "selected" state
    function SelectItem($item, user) {
        selectedUser = user;
        if ($selection !== null) $selection.classList.remove("selected");
        $item.classList.add("selected");
        $selection = $item;
        document.getElementById("submit").classList.remove("hide");
    }

    // Un-select all items when page body is clicked
    document.body.addEventListener("click", function() {
        selectedUser = null;
        if ($selection) $selection.classList.remove("selected");
        $selection = null;
        document.getElementById("submit").classList.add("hide");
    });

    // go to next page on 'continue'
    document.getElementById("submit").addEventListener("click", function() {
        if (selectedUser === null) return;
        let params = {
            id: selectedUser.ID,
            name: selectedUser.DISPLAY_ID,
        };
        window.location.assign("/goodbye/02-input-feelings?" + encodeGetParams(params));
    });

    // go to next page on 'cannot find myself'
    document.getElementById("not-found").addEventListener("click", function() {
        source.close();
        window.location.assign("/goodbye/03-input-feelings-before");
    });

    // listen for updates
    const source = new EventSource('/data/stream');
    source.addEventListener('message', function(e) {
        console.log("DATA RECEIVED", e.data);
        UpdateList();
    }, false);

    // initial update
    UpdateList();

        // your code here
    });


</script>

</body>
</html>